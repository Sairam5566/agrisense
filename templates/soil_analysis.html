<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soil Image Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 50%, #fffbeb 100%); min-height: 100vh; color: #1f2937; }
    .navbar { background: linear-gradient(135deg, #1a5f1a 0%, #2d8f47 100%); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
    .navbar .nav-link, .navbar .navbar-brand { color: #fff !important; }
    .hero { padding: 60px 0; color: #fff; text-align: center; background: linear-gradient(135deg, rgba(26, 95, 26, 0.9), rgba(45, 143, 71, 0.8)); }
    .hero h1 { font-family: 'Poppins', sans-serif; font-weight: 800; }
    .card { border-radius: 16px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
    /* Visual upload box (no drag/drop behavior) */
    .upload-box { border: 2px dashed #a7f3d0; border-radius: 14px; background: #ecfdf5; padding: 16px; }
    .upload-box .hint { color: #065f46; font-weight: 600; text-align: center; }
    .preview { max-width: 100%; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,.06); }
    .badge-soft { background: #e8f5e9; color: #1a5f1a; }
    .analysis-list li { margin-bottom: 6px; }
    .muted { color: #6b7280; }
    /* Match disease page analyze button */
    .btn-agriculture { background: linear-gradient(135deg, #1a5f1a, #2d8f47); color: #fff; border: none; padding: 12px 24px; border-radius: 50px; font-weight: 600; }
  </style>
</head>
<body>
  {% include 'partials/header.html' %}
  <section class="hero">
    <div class="container">
      <h1 class="display-5"><i class="fas fa-microscope"></i> Soil Image Analysis</h1>
      <p class="mb-0">Upload a soil image to estimate soil type and get fertilizer recommendations.</p>
    </div>
  </section>

  <div class="container my-4">
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="card p-3 h-100">
          <h5 class="mb-2"><i class="fas fa-upload"></i> Upload Image</h5>
          <div class="upload-box mb-3">
            <div class="hint mb-2">Drag & drop a soil photo here, or click to select</div>
            <input id="fileInput" type="file" accept="image/*" class="form-control" />
          </div>
          <img id="preview" class="preview d-none" alt="Preview" />
          <button id="analyzeBtn" class="btn-agriculture mt-3" disabled><i class="fas fa-play"></i> Analyze Soil</button>
          <div id="hint" class="small muted mt-2">Tip: Use a clear top-down photo of soil in daylight without heavy shadows.</div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card p-3 h-100">
          <h5 class="mb-2"><i class="fas fa-list-check"></i> Result</h5>
          <div id="loading" class="d-none text-muted"><i class="fas fa-spinner fa-spin"></i> Analyzing...</div>
          <div id="error" class="alert alert-danger d-none"></div>
          <div id="result" class="d-none">
            <div class="mb-2"><span class="badge badge-soft">Soil Type</span></div>
            <h3 id="soilType" class="mb-1"></h3>
            <div class="muted">Confidence: <span id="confidence"></span></div>
            <p id="notes" class="mt-2"></p>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="p-3 border rounded h-100">
                  <h6 class="mb-2"><i class="fas fa-flask"></i> Fertilizer Suggestions</h6>
                  <ul id="fertilizerList" class="analysis-list mb-0"></ul>
                </div>
              </div>
              <div class="col-md-6">
                <div class="p-3 border rounded h-100">
                  <h6 class="mb-2"><i class="fas fa-leaf"></i> General Advice</h6>
                  <ul id="adviceList" class="analysis-list mb-0"></ul>
                </div>
              </div>
            </div>
            <div class="mt-3 small text-muted">Avg color (RGB): <span id="avgRgb"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="py-4 text-center text-muted small">
    <div class="container">&copy; 2025 Agriculture Portal. Guidance onlyâ€”follow soil test recommendations when available.</div>
  </footer>

  <script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');

    const soilTypeEl = document.getElementById('soilType');
    const confidenceEl = document.getElementById('confidence');
    const notesEl = document.getElementById('notes');
    const fertList = document.getElementById('fertilizerList');
    const adviceList = document.getElementById('adviceList');
    const avgRgbEl = document.getElementById('avgRgb');

    function setState({loading=false, error='', showResult=false}){
      loadingEl.classList.toggle('d-none', !loading);
      errorEl.classList.toggle('d-none', !error);
      if (error) errorEl.textContent = error;
      resultEl.classList.toggle('d-none', !showResult);
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      preview.src = url; preview.classList.remove('d-none');
      analyzeBtn.disabled = false;
      setState({loading:false, error:'', showResult:false});
    });

    analyzeBtn.addEventListener('click', async () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;
      setState({loading:true, error:'', showResult:false});
      try {
        const form = new FormData();
        form.append('file', file);
        const res = await fetch('/api/soil/analyze', { method: 'POST', body: form });
        if (!res.ok) {
          const msg = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status}: ${res.statusText} ${msg}`);
        }
        const data = await res.json();
        soilTypeEl.textContent = data.soil_type || '-';
        confidenceEl.textContent = data.confidence ? (Math.round(data.confidence*100)/100) : '-';
        notesEl.textContent = data.notes || '';
        fertList.innerHTML = '';
        (data.fertilizer || []).forEach(t => { const li = document.createElement('li'); li.textContent = t; fertList.appendChild(li); });
        adviceList.innerHTML = '';
        (data.advice || []).forEach(t => { const li = document.createElement('li'); li.textContent = t; adviceList.appendChild(li); });
        avgRgbEl.textContent = (data.avg_rgb || []).join(', ');
        setState({loading:false, error:'', showResult:true});
      } catch(err) {
        console.error(err);
        setState({loading:false, error: err.message || 'Failed to analyze image', showResult:false});
      }
    });

    // drag and drop UX on dropzone wrapper
    const drop = document.getElementById('dropzone');
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
    drop.addEventListener('drop', (e)=>{
      e.preventDefault(); drop.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        fileInput.files = e.dataTransfer.files;
        const change = new Event('change'); fileInput.dispatchEvent(change);
      }
    });
    drop.addEventListener('click', ()=> fileInput.click());
  </script>
  <script src="/template/translate.js"></script>
</body>
</html>
